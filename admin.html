<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - The Fidget Shop</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 140px 5% 60px;
        }
        
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .admin-content {
            display: none;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }
        
        .admin-header h2 {
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logout-btn {
            padding: 10px 25px;
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
            color: var(--bg-dark);
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .logout-btn:hover {
            transform: translateY(-2px);
        }
        
        .admin-section {
            margin-bottom: 40px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 30px;
        }
        
        .admin-section h3 {
            color: var(--gradient-end);
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .order-item, .message-item {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .order-header, .message-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .order-header:hover, .message-header:hover {
            background: rgba(103, 172, 255, 0.1);
        }
        
        .order-details, .message-details {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .order-details.open, .message-details.open {
            max-height: 1000px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .order-summary {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .order-summary div {
            display: flex;
            justify-content: space-between;
            color: var(--text-light);
        }
        
        .order-summary strong {
            color: var(--gradient-end);
        }
        
        .product-list {
            background: rgba(103, 172, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .product-list h4 {
            color: var(--gradient-end);
            margin-bottom: 10px;
        }
        
        .product-list-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }
        
        .product-list-item:last-child {
            border-bottom: none;
        }
        
        .chevron {
            transition: transform 0.3s;
        }
        
        .chevron.open {
            transform: rotate(180deg);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-subtle);
        }
        
        .badge {
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
            color: var(--bg-dark);
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo"><h1>The Fidget Shop</h1></div>
        <div class="nav-container">
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="page3.html">Our Collection</a></li>
                    <li><a href="page4.html">All Products</a></li>
                    <li><a href="page5.html">Our Favorites</a></li>
                    <li><a href="page6.html">Shipping FAQ</a></li>
                    <li><a href="page1.html">About Us</a></li>
                    <li><a href="page2.html">Contact</a></li>
                </ul>
            </nav>
        </div>
        <a href="page7.html" class="cart-button">
            <span class="cart-icon">üõí</span>
            <span class="cart-count" id="cartCount">0</span>
        </a>
    </header>

    <div id="loginForm" class="login-form">
        <h2>üîê Admin Login</h2>
        <form onsubmit="return handleLogin(event)">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit" class="place-order-btn">Login</button>
            <div class="error-message" id="errorMessage">Invalid username or password</div>
        </form>
    </div>

    <div id="adminContent" class="admin-content">
        <div class="admin-container">
            <div class="admin-header">
                <h2>Admin Panel</h2>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>

            <div class="admin-section">
                <h3>üì¶ Recent Orders <span class="badge" id="orderCount">0</span></h3>
                <div id="ordersContainer"></div>
            </div>

            <div class="admin-section">
                <h3>‚úâÔ∏è Contact Messages <span class="badge" id="messageCount">0</span></h3>
                <div id="messagesContainer"></div>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 The Fidget Shop. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script>
        const ADMIN_USERS = {
            'rory': 'thefidgshop',
            'haydan': 'thefidgshop',
            'temp': 'thefidgshop'
        };

        window.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            if (isLoggedIn === 'true') {
                showAdminPanel();
            }
            updateCartCount();
        });

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (ADMIN_USERS[username] && ADMIN_USERS[username] === password) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                sessionStorage.setItem('adminUsername', username);
                showAdminPanel();
            } else {
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('errorMessage').style.display = 'none';
                }, 3000);
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('adminLoggedIn');
            sessionStorage.removeItem('adminUsername');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('adminContent').style.display = 'none';
        }

        function showAdminPanel() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            loadOrders();
            loadMessages();
        }

        async function loadOrders() {
            const container = document.getElementById('ordersContainer');
            const countBadge = document.getElementById('orderCount');
            
            try {
                const username = sessionStorage.getItem('adminUsername');
                if (!username || !ADMIN_USERS[username]) {
                    container.innerHTML = '<div class="empty-state">Please log in to view orders</div>';
                    return;
                }
                
                const password = ADMIN_USERS[username];
                const auth = btoa(`${username}:${password}`);
                
                const response = await fetch('/api/orders', {
                    headers: {
                        'Authorization': `Basic ${auth}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Authentication failed');
                }
                
                const orders = await response.json();
                
                countBadge.textContent = orders.length;
                
                if (orders.length === 0) {
                    container.innerHTML = '<div class="empty-state">No orders yet</div>';
                    return;
                }
                
                container.innerHTML = orders.map((order, index) => `
                    <div class="order-item">
                        <div class="order-header" onclick="toggleOrder(${index})">
                            <div>
                                <strong>${order.full_name || 'Guest'}</strong>
                                <span style="color: var(--text-subtle); margin-left: 15px;">
                                    ${new Date(order.timestamp).toLocaleString()}
                                </span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="color: var(--gradient-end); font-weight: 600;">
                                    ${order.total}
                                </span>
                                <span class="chevron" id="chevron-${index}">‚ñº</span>
                            </div>
                        </div>
                        <div class="order-details" id="order-${index}">
                            <div class="order-summary">
                                <div><span>Email:</span> <span>${order.email}</span></div>
                                ${order.delivery_method === 'shipping' ? `
                                    <div><span>Delivery:</span> <span>Shipping ($5.00)</span></div>
                                    <div><span>Address:</span> <span>${order.address || 'N/A'}</span></div>
                                    <div><span>City:</span> <span>${order.city || ''}, ${order.state || ''} ${order.zip_code || ''}</span></div>
                                ` : `
                                    <div><span>Delivery:</span> <span>Local Pickup (Free)</span></div>
                                `}
                                <div><span>Payment Method:</span> <span>${order.payment_method === 'cash' ? 'Cash (In-person)' : 'Credit Card'}</span></div>
                                <div style="border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 10px;">
                                    <strong>Subtotal:</strong> <strong>${order.subtotal}</strong>
                                </div>
                                <div><strong>Shipping:</strong> <strong>${order.shipping}</strong></div>
                                <div style="color: var(--gradient-end);"><strong>Total:</strong> <strong>${order.total}</strong></div>
                            </div>
                            <div class="product-list">
                                <h4>Items Ordered:</h4>
                                ${order.items.map(item => `
                                    <div class="product-list-item">
                                        <span>${item.name}${item.color && item.color !== 'Default' ? ` (${item.color})` : ''}</span>
                                        <span>${item.price}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading orders:', error);
                container.innerHTML = '<div class="empty-state">Error loading orders. Please try again.</div>';
            }
        }

        async function loadMessages() {
            const container = document.getElementById('messagesContainer');
            const countBadge = document.getElementById('messageCount');
            
            try {
                const username = sessionStorage.getItem('adminUsername');
                if (!username || !ADMIN_USERS[username]) {
                    container.innerHTML = '<div class="empty-state">Please log in to view messages</div>';
                    return;
                }
                
                const password = ADMIN_USERS[username];
                const auth = btoa(`${username}:${password}`);
                
                const response = await fetch('/api/contact', {
                    headers: {
                        'Authorization': `Basic ${auth}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Authentication failed');
                }
                
                const messages = await response.json();
                
                countBadge.textContent = messages.length;
                
                if (messages.length === 0) {
                    container.innerHTML = '<div class="empty-state">No messages yet</div>';
                    return;
                }
                
                container.innerHTML = messages.map((msg, index) => `
                    <div class="message-item">
                        <div class="message-header" onclick="toggleMessage(${index})">
                            <div>
                                <strong>${msg.name}</strong>
                                <span style="color: var(--text-subtle); margin-left: 15px;">
                                    ${new Date(msg.timestamp).toLocaleString()}
                                </span>
                            </div>
                            <span class="chevron" id="msg-chevron-${index}">‚ñº</span>
                        </div>
                        <div class="message-details" id="message-${index}">
                            <div class="order-summary">
                                <div><span>Email:</span> <span>${msg.email}</span></div>
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                    <strong>Message:</strong>
                                    <p style="margin-top: 10px; line-height: 1.6; color: var(--text-light);">${msg.message}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading messages:', error);
                container.innerHTML = '<div class="empty-state">Error loading messages. Please try again.</div>';
            }
        }

        function toggleOrder(index) {
            const details = document.getElementById(`order-${index}`);
            const chevron = document.getElementById(`chevron-${index}`);
            details.classList.toggle('open');
            chevron.classList.toggle('open');
        }

        function toggleMessage(index) {
            const details = document.getElementById(`message-${index}`);
            const chevron = document.getElementById(`msg-chevron-${index}`);
            details.classList.toggle('open');
            chevron.classList.toggle('open');
        }
    </script>
</body>
</html>
